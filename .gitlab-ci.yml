image: docker.uib.gmbh/opsi/dev/pybuilder:uib-python-3.9

stages:
  - test
  - package
  - publish

test:pylint-pytest:
  #when: manual
  services:
    - name: mysql:latest
      command:
        - --max_connections=1000
  variables:
    MYSQL_ROOT_PASSWORD: "opsi"
    MYSQL_DATABASE: "opsi"
  stage: test
  script: |
    # Installing opsi testmodules file
    mkdir -p /etc/opsi
    mkdir -p /var/log/opsi
    #echo "${OPSI_TEST_MODULES}" > /etc/opsi/modules
    cp tests/data/license/modules /etc/opsi
    cat /etc/opsi/modules
    # cloning opsi-server for data directory
    rm -rf ../opsi-server
    rm -rf data
    git clone -b master https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.uib.gmbh/uib/opsi-server.git ../opsi-server
    ln -s ../opsi-server/opsi-server_data/etc data
    cp tests/Backends/config.py.gitlabci tests/Backends/config.py
    # echo "deb http://deb.debian.org/debian unstable main" >> /etc/apt/sources.list
    # apt update
    # apt-get --yes install libmysqlclient-dev mysql-client librsync2 #careful: this bumps glibc to at least 2.31
    poetry lock --no-update
    poetry install
    poetry run pylint --disable=R,C,W OPSI
    poetry run pytest -o junit_family=xunit2 --junitxml=testreport.xml --cov-append --cov-report term --cov-report xml -v tests
  coverage: '/TOTAL\s+\d+\s+\d+\s+(\d+)%/'
  artifacts:
    name: 'python-opsi_test'
    paths:
      - coverage.xml
      - testreport.xml
    reports:
        junit: testreport.xml
    expire_in: 14 days

publish:uibpypi:
  stage: publish
  script:
    #- echo "deb http://deb.debian.org/debian unstable main" >> /etc/apt/sources.list
    #- apt update
    #- apt-get --yes install libmysqlclient-dev mysql-client librsync2 #careful: this bumps glibc to at least 2.31
    - poetry lock --no-update
    - poetry install
    - poetry run opsi-dev-tool -l info --uib-pypi-publish
  only:
    - tags
