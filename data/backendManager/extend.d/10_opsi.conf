# -*- coding: utf-8 -*-


def setProductActionRequestWithDependencies(self, productId, clientId, actionRequest):
	modified = False
	productOnClientsByProductId = {}
	addProductOnClientDefaults = self._backend.backend_getOptions().get("addProductOnClientDefaults", False)
	try:
		self._backend.backend_setOptions({"addProductOnClientDefaults": True})
		productOnClients = self._backend.productOnClient_getObjects(clientId = clientId)
	finally:
		self._backend.backend_setOptions({"addProductOnClientDefaults": addProductOnClientDefaults})

	if productOnClients:
		for poc in productOnClients:
			if not productOnClientsByProductId.has_key(poc.getProductId()):
				productOnClientsByProductId[poc.getProductId()] = poc

	print('Before emptying: PoC: {0}'.format(productOnClients))
	productOnClients = []

	print('Searching for: {0}'.format(productId))
	print('PoC by ID: {0}'.format(productOnClientsByProductId))
	print('PoC: {0}'.format(productOnClients))

	if productOnClientsByProductId.has_key(productId):
		productOnClients.append(productOnClientsByProductId[productId])
	else:
		productOnClients.append(ProductOnClient(
			productId          = productId,
			productType        = 'LocalbootProduct',
			clientId           = clientId,
			installationStatus = 'not_installed'
		))

	print('After: PoC: {0}'.format(productOnClients))

	if productOnClients[0].getActionRequest() != actionRequest:
		productOnClients[0].setActionRequest(actionRequest)
		modified = True

	print('Action Request of {poc} was modified? {0}'.format(modified, poc=productOnClients[0]))

	if modified:
		productOnClientsWithDependencies = self._backend.productOnClient_addDependencies(productOnClients)
		print('Dependencies: {0}'.format(productOnClientsWithDependencies))
		if not productOnClientsWithDependencies:
			raise Exception("FUCK NO NO NO NO NO PRODUCTS!")
		if productOnClientsWithDependencies:
			for poc in productOnClientsWithDependencies:
				if poc.getProductId() == productId:
					if poc.getActionRequest() != actionRequest:
						raise BackendIOError("Error occured by resolving the dependendcies that configured in product: '%s'. No ProductAction will be set." % productId)

			# raise Exception(repr(productOnClients))  # eins weiter ;)
			for poc in productOnClientsWithDependencies:
				if poc.getProductId() == productId:
					continue
				elif productOnClientsByProductId.has_key(poc.getProductId()):
					if not productOnClientsByProductId[poc.getProductId()].getInstallationStatus() == "installed":
						requiredProduct = productOnClientsByProductId[poc.getProductId()]
						requiredProduct.setActionRequest(poc.getActionRequest())
						productOnClients.append(requiredProduct)
			if productOnClients:
				self._backend.productOnClient_updateObjects(productOnClients)

def userIsReadOnlyUser(self):
	return self.accessControl_userIsReadOnlyUser()
